<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Keersommen</title>

<style>
  body{
    font-family:system-ui,sans-serif;
    background:#f4f6ff;
    margin:0;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center
  }
  .box{
    background:#fff;
    padding:2rem 2.4rem;
    border-radius:1.5rem;
    box-shadow:0 10px 30px rgba(0,0,0,.1);
    max-width:760px;
    width:95%;
    text-align:center
  }
  .top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:1rem;
    margin-bottom:1rem;
    flex-wrap:wrap;
  }
  a{
    text-decoration:none;
    font-weight:800;
    color:#4f46e5
  }
  .pill{
    background:#eef2ff;
    padding:.35rem .7rem;
    border-radius:999px;
    font-weight:900
  }
  .q{
    font-size:3rem;
    margin:1.2rem 0;
    min-height:3.2rem;
  }
  input#answer{
    font-size:1.6rem;
    padding:.5rem .9rem;
    width:240px;
    text-align:center;
    border-radius:.9rem;
    border:2px solid #ccc;
    outline:none;
  }
  input#answer:focus{
    border-color:#4f46e5;
    box-shadow:0 0 0 3px rgba(79,70,229,.15);
  }
  button{
    margin-top:1rem;
    padding:.8rem 1.3rem;
    border:none;
    border-radius:999px;
    background:#4f46e5;
    color:white;
    font-weight:900;
    cursor:pointer
  }
  button.secondary{
    background:#0f172a;
  }
  button:disabled{
    background:#bbb;
    cursor:default
  }
  .feedback{
    height:1.4rem;
    font-weight:900;
    margin-top:.4rem;
  }
  .good{color:#16a34a}
  .bad{color:#dc2626}

  .panel{
    margin-top:1.2rem;
    background:#f7f8ff;
    border:1px solid #e6e8ff;
    border-radius:1rem;
    padding:1rem;
    text-align:left
  }
  .panel .btnrow{
    display:flex;
    gap:.6rem;
    flex-wrap:wrap;
    margin-top:.6rem;
    align-items:center
  }
  .panel input#code{
    font-size:1rem;
    padding:.55rem .8rem;
    border-radius:.8rem;
    border:2px solid #ccc;
    outline:none;
    flex:1;
    min-width:260px;
  }
  .smalltxt{
    font-size:.85rem;
    color:#666
  }
</style>
</head>

<body>
<div class="box">

  <div class="top">
    <a href="menu.html">‚Üê Menu</a>
    <div class="pill" id="who"></div>
  </div>

  <h1>Keersommen</h1>
  <div class="pill" id="level"></div>

  <p>
    ‚è± <span id="time">2:00</span> |
    ‚úÖ <span id="good">0</span> |
    üìä <span id="tries">0</span>
  </p>

  <div class="q" id="question">Klik op start</div>
  <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" disabled placeholder="antwoord">
  <div class="feedback" id="feedback"></div>

  <button id="start">Start</button>

  <!-- ===== CODE BLOK (zoals bij Delen) ===== -->
  <div class="panel">
    <div><b>Code voor MOO (niveau meenemen)</b></div>
    <div class="smalltxt">
      Klik <b>Maak code</b>, kopieer en plak in MOO. Op een andere Chromebook: plak en klik <b>Laad code</b>.
    </div>
    <div class="btnrow">
      <button id="make">Maak code</button>
      <button id="load" class="secondary">Laad code</button>
      <input id="code" placeholder="code..." />
    </div>
    <div class="smalltxt" id="msg"></div>
  </div>

</div>

<script>
  // ===== leerling =====
  const CURRENT = "rekenen_current_student_v1";
  const DATA = "rekenen_data_v1_";
  const id = localStorage.getItem(CURRENT);
  if(!id) location.href="index.html";
  document.getElementById("who").textContent = `Leerling: ${id}`;

  function key(){ return DATA+id }
  function getData(){
    return JSON.parse(localStorage.getItem(key())) || {v:1, id, levels:{plus:0,min:0,keer:0,deel:0}}
  }
  function saveData(d){ localStorage.setItem(key(),JSON.stringify(d)) }

  // ===== levels =====
  const LEVELS = [
    "Tafel van 2",
    "Tafel van 2 en 10",
    "Tafel van 2, 5 en 10",
    "Tafel van 3 en 4",
    "Tafel van 2,3,4,5 en 10",
    "Tafel van 6 en 7",
    "Tafel van 2,3,4,5,6,7 en 10",
    "Tafel van 8 en 9",
    "Alle tafels",
    "Stipsommen (8 √ó ... = 56)",
    "Grote keersommen (80√ó9, 800√ó9, 80√ó90)"
  ];

  // ===== helpers =====
  function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min }
  function pick(arr){ return arr[r(0,arr.length-1)] }

  // ===== UI =====
  const qEl = document.getElementById("question");
  const aEl = document.getElementById("answer");
  const fEl = document.getElementById("feedback");
  const tEl = document.getElementById("time");
  const gEl = document.getElementById("good");
  const trEl = document.getElementById("tries");
  const lvlEl = document.getElementById("level");

  let time=120, timer=null, running=false, good=0, tries=0, correct=0;

  function getLevel(){
    const d = getData();
    const lvl = d.levels?.keer ?? 0;
    return Math.min(Math.max(0,lvl), LEVELS.length-1);
  }

  function renderLevel(){
    lvlEl.textContent = `Niveau: ${LEVELS[getLevel()]}`;
  }

  // ===== vraag =====
  function makeQuestion(level){

    // niveau 10: stipsom (index 9)
    if(level===9){
      const a = pick([2,3,4,5,6,7,8,9,10]);
      const b = r(0,10);
      correct = b;
      qEl.innerHTML = `${a} √ó ... = ${a*b}`;
      return;
    }

    // niveau 11: grote keersommen (index 10)
    if(level===10){
      const type = pick(["tiental","honderdtal","tientalxtiental"]);

      if(type==="tiental"){
        const a=pick([10,20,30,40,50,60,70,80,90]);
        const b=r(2,9);
        correct=a*b;
        qEl.textContent=`${a} √ó ${b}`;
        return;
      }

      if(type==="honderdtal"){
        const a=pick([100,200,300,400,500,600,700,800,900]);
        const b=r(2,9);
        correct=a*b;
        qEl.textContent=`${a} √ó ${b}`;
        return;
      }

      if(type==="tientalxtiental"){
        const a=pick([10,20,30,40,50,60,70,80,90]);
        const b=pick([10,20,30,40,50,60,70,80,90]);
        correct=a*b;
        qEl.textContent=`${a} √ó ${b}`;
        return;
      }
    }

    // normale tafels
    let tables=[];
    if(level===0) tables=[2];
    if(level===1) tables=[2,10];
    if(level===2) tables=[2,5,10];
    if(level===3) tables=[3,4];
    if(level===4) tables=[2,3,4,5,10];
    if(level===5) tables=[6,7];
    if(level===6) tables=[2,3,4,5,6,7,10];
    if(level===7) tables=[8,9];
    if(level===8) tables=[2,3,4,5,6,7,8,9,10];

    const tafel = pick(tables);
    const getal = r(0,10);
    correct = tafel * getal;

    // zoals jij wil: 8 √ó 2 (i.p.v. 2 √ó 8)
    qEl.textContent = `${getal} √ó ${tafel}`;
  }

  function fmtTime(){
    tEl.textContent = `${Math.floor(time/60)}:${String(time%60).padStart(2,"0")}`;
  }

  function resetRun(){
    good=0; tries=0; time=120;
    gEl.textContent="0"; trEl.textContent="0";
    fEl.textContent=""; fEl.className="feedback";
    fmtTime();
    renderLevel();
    qEl.textContent="Klik op start";
    aEl.value="";
    aEl.disabled=true;
    running=false;
    if(timer){ clearInterval(timer); timer=null; }
  }

  // ===== start =====
  document.getElementById("start").onclick=()=>{
    const d=getData();
    const lvl=getLevel();
    renderLevel();

    good=0; tries=0; time=120;
    gEl.textContent="0"; trEl.textContent="0";
    fmtTime();

    aEl.disabled=false;
    aEl.value="";
    aEl.focus();

    running=true;
    makeQuestion(lvl);

    if(timer) clearInterval(timer);
    timer=setInterval(()=>{
      time--;
      fmtTime();
      if(time<=0){
        clearInterval(timer);
        timer=null;
        running=false;
        aEl.disabled=true;

        if(good>=24 && lvl<LEVELS.length-1){
          d.levels = d.levels || {plus:0,min:0,keer:0,deel:0};
          d.levels.keer = lvl+1;
          saveData(d);
          alert("üéâ Niveau omhoog!");
          renderLevel();
        }
      }
    },1000);
  };

  // ===== antwoord (Enter) =====
  aEl.addEventListener("keydown",(e)=>{
    if(e.key!=="Enter") return;
    if(!running) return;

    const raw = aEl.value.trim().replace(/[^0-9]/g,"");
    if(raw==="") return;

    tries++; trEl.textContent=String(tries);

    if(Number(raw)===correct){
      good++; gEl.textContent=String(good);
      fEl.textContent="Goed!";
      fEl.className="feedback good";
    }else{
      fEl.textContent=`Fout (antwoord: ${correct})`;
      fEl.className="feedback bad";
    }

    aEl.value="";
    makeQuestion(getLevel());
    aEl.focus();
  });

  // ===== MOO export/import (zelfde als Delen) =====
  const codeEl = document.getElementById("code");
  const msgEl  = document.getElementById("msg");

  function checksum(str){
    let h=0;
    for(let i=0;i<str.length;i++) h=(h*31+str.charCodeAt(i))>>>0;
    return h.toString(36);
  }
  function b64encode(str){ return btoa(unescape(encodeURIComponent(str))); }
  function b64decode(str){ return decodeURIComponent(escape(atob(str))); }

  document.getElementById("make").addEventListener("click", ()=>{
    const d = getData();
    const payload = { v:1, id:d.id, levels:d.levels };
    const json = JSON.stringify(payload);
    const packed = b64encode(json) + "." + checksum(json);
    codeEl.value = packed;
    codeEl.select();
    try{ document.execCommand("copy"); }catch(e){}
    msgEl.textContent = "Code gemaakt (vaak al gekopieerd). Plak in MOO.";
  });

  document.getElementById("load").addEventListener("click", ()=>{
    const raw = (codeEl.value||"").trim();
    if(!raw){ msgEl.textContent="Plak eerst een code."; return; }

    const parts = raw.split(".");
    if(parts.length!==2){ msgEl.textContent="Code klopt niet (formaat)."; return; }

    try{
      const json = b64decode(parts[0]);
      if(checksum(json)!==parts[1]){ msgEl.textContent="Code klopt niet (controle)."; return; }

      const payload = JSON.parse(json);
      if(!payload || payload.v!==1 || payload.id!==id || !payload.levels){
        msgEl.textContent="Code is niet voor deze leerling.";
        return;
      }

      // merge levels (zodat plus/min/deel ook mee kunnen, als je dat wil)
      const d = getData();
      d.levels = d.levels || {plus:0,min:0,keer:0,deel:0};
      d.levels = {...d.levels, ...payload.levels};
      saveData(d);

      renderLevel();
      msgEl.textContent="Geladen!";
    } catch(e){
      msgEl.textContent="Kon code niet lezen.";
    }
  });

  // init
  renderLevel();
  fmtTime();
</script>
</body>
</html>
