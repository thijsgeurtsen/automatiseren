<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keersommen</title>
  <style>
    body{font-family:system-ui,sans-serif;background:#f4f6ff;margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center}
    .box{background:#fff;padding:2rem 2.4rem;border-radius:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:820px;width:95%;text-align:center}
    .top{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
    a{text-decoration:none;font-weight:800;color:#4f46e5}
    .pill{background:#eef2ff;padding:.35rem .7rem;border-radius:999px;font-weight:900}
    h1{margin:.2rem 0 1rem 0;font-size:2.2rem}
    .levelbar{margin:.2rem auto 1.2rem auto;background:#eef2ff;padding:.6rem .9rem;border-radius:999px;font-weight:900;max-width:560px}
    .stats{font-size:1.1rem;margin:.8rem 0 1.4rem 0}
    .q{font-size:4rem;margin:1.2rem 0 1.2rem 0;min-height:4.2rem;letter-spacing:1px}
    #answer{font-size:1.8rem;padding:.6rem 1rem;width:260px;text-align:center;border-radius:1rem;border:2px solid #cfcfe6;outline:none}
    #answer:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.18)}
    .feedback{height:1.6rem;font-weight:900;margin-top:.6rem}
    .good{color:#16a34a}
    .bad{color:#dc2626}
    button{margin-top:1.1rem;padding:.85rem 1.35rem;border:none;border-radius:999px;background:#4f46e5;color:white;font-weight:900;cursor:pointer;font-size:1rem;min-width:140px}
    button:disabled{background:#b9b9c7;cursor:default}
    .smalltxt{font-size:.85rem;color:#666;line-height:1.35;margin-top:.5rem}
  </style>
</head>

<body>
  <div class="box">
    <div class="top">
      <a href="menu.html">‚Üê Menu</a>
      <div class="pill" id="who">Leerling: -</div>
    </div>

    <h1>Keersommen</h1>
    <div class="levelbar" id="level">Niveau: laden‚Ä¶</div>
    <div class="smalltxt" id="sheetStatus">Sheets: verbinden‚Ä¶</div>

    <div class="stats">
      ‚è± <span id="time">2:00</span> |
      ‚úÖ <span id="good">0</span> |
      üìä <span id="tries">0</span>
    </div>

    <div class="q" id="question">Klik op start</div>
    <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="antwoord" disabled>
    <div class="feedback" id="feedback"></div>

    <button id="startBtn" disabled>Start</button>
    <div class="smalltxt">Tip: druk op <b>Enter</b> om te controleren.</div>
  </div>

<script>
/* =========================
   A) CONFIG: jouw Apps Script exec-url
========================= */
const SHEETS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzwJm59S4rcRcLyvzxslTocnBSYv7KnOinPn72X9ji43CkQhDwjyY8gfjE7YnP-zYUBTQ/exec";

/* =========================
   B) Leerling uit localStorage
========================= */
const CURRENT = "rekenen_current_student_v1";
const studentId = (localStorage.getItem(CURRENT) || "").trim();

if(!studentId){
  location.href = "index.html";
}

document.getElementById("who").textContent = `Leerling: ${studentId}`;

/* =========================
   C) Niveau‚Äôs (Keer)
========================= */
const LEVELS = [
  "Tafel van 2",
  "Tafel van 2 en 10",
  "Tafel van 2, 5 en 10",
  "Tafel van 3 en 4",
  "Tafel van 2,3,4,5 en 10",
  "Tafel van 6 en 7",
  "Tafel van 2,3,4,5,6,7 en 10",
  "Tafel van 8 en 9",
  "Alle tafels",
  "Stipsommen met tafels (8 √ó ‚Ä¶ = 56)",
  "Grote keersommen (80√ó9, 800√ó9, 80√ó90)"
];

const PROMOTE_AT = 24;

/* =========================
   D) UI refs
========================= */
const qEl = document.getElementById("question");
const aEl = document.getElementById("answer");
const fEl = document.getElementById("feedback");
const tEl = document.getElementById("time");
const goodEl = document.getElementById("good");
const triesEl = document.getElementById("tries");
const levelEl = document.getElementById("level");
const startBtn = document.getElementById("startBtn");
const sheetStatusEl = document.getElementById("sheetStatus");

/* =========================
   E) JSONP helper (werkt zonder CORS)
========================= */
let __jsonpSeq = 0;
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "__cb_" + (++__jsonpSeq) + "_" + Date.now();
    const script = document.createElement("script");

    const cleanup = () => {
      delete window[cb];
      script.remove();
    };

    window[cb] = (data) => { cleanup(); resolve(data); };

    script.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    document.body.appendChild(script);
  });
}

/* =========================
   F) Sheets API: get / set levels
========================= */
async function sheetsGet(leerling){
  const url = `${SHEETS_EXEC_URL}?action=get&leerling=${encodeURIComponent(leerling)}`;
  return await jsonp(url);
}

async function sheetsSet(leerling, levels){
  const url =
    `${SHEETS_EXEC_URL}?action=set&leerling=${encodeURIComponent(leerling)}`
    + `&plus=${encodeURIComponent(levels.plus)}`
    + `&min=${encodeURIComponent(levels.min)}`
    + `&keer=${encodeURIComponent(levels.keer)}`
    + `&deel=${encodeURIComponent(levels.deel)}`;
  return await jsonp(url);
}

/* =========================
   G) Spel state
========================= */
let running=false;
let timer=null;
let time=120;
let good=0;
let tries=0;
let correctAnswer=0;

// niveaus uit Sheets
let levels = { plus:0, min:0, keer:0, deel:0 };

function clampLevel(lvl){
  return Math.max(0, Math.min(lvl, LEVELS.length - 1));
}

function renderLevel(){
  const lvl = clampLevel(Number(levels.keer) || 0);
  levelEl.textContent = "Niveau: " + LEVELS[lvl];
}

function fmtTime(){
  tEl.textContent = `${Math.floor(time/60)}:${String(time%60).padStart(2,"0")}`;
}

function setFeedback(text, ok){
  fEl.textContent = text;
  fEl.className = "feedback " + (ok ? "good" : "bad");
}
function clearFeedback(){
  fEl.textContent = "";
  fEl.className = "feedback";
}

/* =========================
   H) Random helpers
========================= */
function r(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[r(0, arr.length-1)]; }

/* =========================
   I) Vraag generator
========================= */
function makeQuestion(){
  const lvl = clampLevel(Number(levels.keer) || 0);

  // Niveau 10: stipsommen: a √ó ‚Ä¶ = product
  if(lvl === 9){
    const a = pick([2,3,4,5,6,7,8,9,10]);
    const b = r(0,10);
    correctAnswer = b;
    qEl.textContent = `${a} √ó ‚Ä¶ = ${a*b}`;
    return;
  }

  // Niveau 11: grote keersommen
  if(lvl === 10){
    const type = pick(["tiental","honderdtal","tientalxtiental"]);
    if(type === "tiental"){
      const a = pick([10,20,30,40,50,60,70,80,90]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }
    if(type === "honderdtal"){
      const a = pick([100,200,300,400,500,600,700,800,900]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }
    const a = pick([10,20,30,40,50,60,70,80,90]);
    const b = pick([10,20,30,40,50,60,70,80,90]); // 80 √ó 90 etc.
    correctAnswer = a*b;
    qEl.textContent = `${a} √ó ${b}`;
    return;
  }

  // Normale tafels per niveau
  let tables = [2];
  if(lvl===0) tables=[2];
  if(lvl===1) tables=[2,10];
  if(lvl===2) tables=[2,5,10];
  if(lvl===3) tables=[3,4];
  if(lvl===4) tables=[2,3,4,5,10];
  if(lvl===5) tables=[6,7];
  if(lvl===6) tables=[2,3,4,5,6,7,10];
  if(lvl===7) tables=[8,9];
  if(lvl===8) tables=[2,3,4,5,6,7,8,9,10];

  const tafel = pick(tables);
  const getal = r(0,10);

  // jouw wens: 8 √ó 2 (dus eerst het getal)
  correctAnswer = getal * tafel;
  qEl.textContent = `${getal} √ó ${tafel}`;
}

/* =========================
   J) Run start/stop
========================= */
function resetRun(){
  running=false;
  if(timer){ clearInterval(timer); timer=null; }
  time=120; good=0; tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  qEl.textContent="Klik op start";
  aEl.value="";
  aEl.disabled=true;
  startBtn.disabled=false;
  clearFeedback();
}

async function promoteIfNeeded(){
  const lvl = clampLevel(Number(levels.keer) || 0);
  if(good >= PROMOTE_AT && lvl < LEVELS.length-1){
    levels.keer = lvl + 1;
    renderLevel();
    sheetStatusEl.textContent = "Sheets: niveau opslaan‚Ä¶";
    try{
      await sheetsSet(studentId, levels);
      sheetStatusEl.textContent = "Sheets: opgeslagen ‚úÖ";
    }catch(e){
      sheetStatusEl.textContent = "Sheets: opslaan mislukt ‚ö†Ô∏è";
    }
    alert("üéâ Niveau omhoog!");
  }
}

function startRun(){
  running=true;
  startBtn.disabled=true;

  time=120; good=0; tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  clearFeedback();

  aEl.disabled=false;
  aEl.value="";
  aEl.focus();

  makeQuestion();

  if(timer) clearInterval(timer);
  timer=setInterval(()=>{
  time--;
  fmtTime();

  if(time<=0){
    clearInterval(timer);
    timer=null;
    running=false;
    aEl.disabled=true;
    startBtn.disabled=false;
    promoteIfNeeded(); // geen await
  }
}, 1000);

}

/* =========================
   K) Antwoord afhandeling
========================= */
function submitAnswer(){
  if(!running) return;

  const raw = aEl.value.trim().replace(/[^0-9]/g,"");
  if(raw==="") return;

  tries++;
  triesEl.textContent = String(tries);

  const val = Number(raw);
  if(val === correctAnswer){
    good++;
    goodEl.textContent = String(good);
    setFeedback("Goed!", true);
  }else{
    setFeedback(`Fout (antwoord: ${correctAnswer})`, false);
  }

  aEl.value="";
  makeQuestion();
  aEl.focus();
}

aEl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter") submitAnswer();
});

startBtn.addEventListener("click", startRun);

/* =========================
   L) INIT: haal levels uit Sheets
========================= */
(async function init(){
  fmtTime();
  sheetStatusEl.textContent = "Sheets: laden‚Ä¶";

  try{
    const res = await sheetsGet(studentId);

    if(!res || res.ok !== true || !res.levels){
      sheetStatusEl.textContent = "Sheets: onverwacht antwoord ‚ö†Ô∏è";
      levelEl.textContent = "Niveau: -";
      startBtn.disabled = false; // toch spelen op 0
      return;
    }

    levels = {
      plus: Number(res.levels.plus) || 0,
      min:  Number(res.levels.min)  || 0,
      keer: Number(res.levels.keer) || 0,
      deel: Number(res.levels.deel) || 0
    };

    renderLevel();
    sheetStatusEl.textContent = "Sheets: verbonden ‚úÖ";
    startBtn.disabled = false;

  }catch(e){
    // fallback: spelen zonder Sheets
    levels = { plus:0, min:0, keer:0, deel:0 };
    renderLevel();
    sheetStatusEl.textContent = "Sheets: verbinden mislukt ‚ö†Ô∏è (je kunt wel spelen)";
    startBtn.disabled = false;
  }
})();
</script>
</body>
</html>
