<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keersommen</title>
  <style>
    body{
      font-family:system-ui,sans-serif;
      background:#f4f6ff;
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center
    }
    .box{
      background:#fff;
      padding:2rem 2.4rem;
      border-radius:1.5rem;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
      max-width:820px;
      width:95%;
      text-align:center
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom:1rem;
      flex-wrap:wrap;
    }
    a{
      text-decoration:none;
      font-weight:800;
      color:#4f46e5
    }
    .pill{
      background:#eef2ff;
      padding:.35rem .7rem;
      border-radius:999px;
      font-weight:900
    }
    h1{
      margin:.2rem 0 1rem 0;
      font-size:2.2rem;
    }
    .levelbar{
      margin:.2rem auto 1.2rem auto;
      background:#eef2ff;
      padding:.6rem .9rem;
      border-radius:999px;
      font-weight:900;
      max-width:560px;
    }
    .stats{
      font-size:1.1rem;
      margin:.8rem 0 1.4rem 0;
    }
    .q{
      font-size:4rem;
      margin:1.2rem 0 1.2rem 0;
      min-height:4.2rem;
      letter-spacing:1px;
    }
    #answer{
      font-size:1.8rem;
      padding:.6rem 1rem;
      width:260px;
      text-align:center;
      border-radius:1rem;
      border:2px solid #cfcfe6;
      outline:none;
    }
    #answer:focus{
      border-color:#4f46e5;
      box-shadow:0 0 0 3px rgba(79,70,229,.18);
    }
    .feedback{
      height:1.6rem;
      font-weight:900;
      margin-top:.6rem;
    }
    .good{color:#16a34a}
    .bad{color:#dc2626}

    button{
      margin-top:1.1rem;
      padding:.85rem 1.35rem;
      border:none;
      border-radius:999px;
      background:#4f46e5;
      color:white;
      font-weight:900;
      cursor:pointer;
      font-size:1rem;
      min-width:140px;
    }
    button.secondary{
      background:#0f172a;
    }
    button:disabled{
      background:#b9b9c7;
      cursor:default;
    }

    .panel{
      margin-top:1.6rem;
      background:#f7f8ff;
      border:1px solid #e6e8ff;
      border-radius:1rem;
      padding:1rem;
      text-align:left
    }
    .panel-title{
      font-weight:900;
      margin-bottom:.25rem;
    }
    .smalltxt{
      font-size:.85rem;
      color:#666;
      line-height:1.35;
    }
    .btnrow{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin-top:.7rem;
      align-items:center;
    }
    #code{
      font-size:1rem;
      padding:.6rem .85rem;
      border-radius:.9rem;
      border:2px solid #cfcfe6;
      outline:none;
      flex:1;
      min-width:260px;
      background:#fff;
    }
    #msg{
      margin-top:.4rem;
      font-size:.9rem;
      color:#333;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="box">
    <div class="top">
      <a href="menu.html">‚Üê Menu</a>
      <div class="pill" id="who">Leerling: -</div>
    </div>

    <h1>Keersommen</h1>
    <div class="levelbar" id="level">Niveau: -</div>

    <div class="stats">
      ‚è± <span id="time">2:00</span> |
      ‚úÖ <span id="good">0</span> |
      üìä <span id="tries">0</span>
    </div>

    <div class="q" id="question">Klik op start</div>
    <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="antwoord" disabled>
    <div class="feedback" id="feedback"></div>

    <button id="startBtn">Start</button>

    <!-- Code laden / maken -->
    <div class="panel">
      <div class="panel-title">Code voor MOO (niveau meenemen)</div>
      <div class="smalltxt">
        Klik <b>Maak code</b>, kopieer/plak in MOO. Op een andere Chromebook: plak en klik <b>Laad code</b>.
        (De code is leerling-specifiek.)
      </div>

      <div class="btnrow">
        <button id="makeBtn">Maak code</button>
        <button id="loadBtn" class="secondary">Laad code</button>
        <input id="code" placeholder="Plak hier je code‚Ä¶">
      </div>

      <div id="msg"></div>
    </div>
  </div>

<script>
/* =========================
   1) Leerling + opslag
========================= */
const CURRENT = "rekenen_current_student_v1";
const DATA_PREFIX = "rekenen_data_v1_";

const studentId = localStorage.getItem(CURRENT);
if(!studentId){
  location.href = "index.html";
}

document.getElementById("who").textContent = `Leerling: ${studentId}`;

function dataKey(){ return DATA_PREFIX + studentId; }

function getData(){
  return JSON.parse(localStorage.getItem(dataKey())) || {
    v: 1,
    id: studentId,
    levels: { plus:0, min:0, keer:0, deel:0 }
  };
}

function saveData(d){
  localStorage.setItem(dataKey(), JSON.stringify(d));
}

/* =========================
   2) Niveau‚Äôs (Keer)
========================= */
const LEVELS = [
  "Tafel van 2",
  "Tafel van 2 en 10",
  "Tafel van 2, 5 en 10",
  "Tafel van 3 en 4",
  "Tafel van 2,3,4,5 en 10",
  "Tafel van 6 en 7",
  "Tafel van 2,3,4,5,6,7 en 10",
  "Tafel van 8 en 9",
  "Alle tafels",
  "Stipsommen met tafels (8 √ó ‚Ä¶ = 56)",
  "Grote keersommen (80√ó9, 800√ó9, 80√ó90)"
];

// hoeveel goed voor level-up
const PROMOTE_AT = 24;

// netjes: level ophalen en clampen
function getLevel(){
  const d = getData();
  const lvl = d.levels?.keer ?? 0;
  return Math.max(0, Math.min(lvl, LEVELS.length - 1));
}

function setLevel(lvl){
  const d = getData();
  d.levels = d.levels || { plus:0, min:0, keer:0, deel:0 };
  d.levels.keer = Math.max(0, Math.min(lvl, LEVELS.length - 1));
  saveData(d);
}

function renderLevel(){
  document.getElementById("level").textContent = "Niveau: " + LEVELS[getLevel()];
}

/* =========================
   3) Random helpers
========================= */
function r(min, max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function pick(arr){
  return arr[r(0, arr.length-1)];
}

/* =========================
   4) Spel state + UI refs
========================= */
const qEl = document.getElementById("question");
const aEl = document.getElementById("answer");
const fEl = document.getElementById("feedback");
const tEl = document.getElementById("time");
const goodEl = document.getElementById("good");
const triesEl = document.getElementById("tries");
const startBtn = document.getElementById("startBtn");

let running=false;
let timer=null;
let time=120;
let good=0;
let tries=0;
let correctAnswer=0;

function fmtTime(){
  tEl.textContent = `${Math.floor(time/60)}:${String(time%60).padStart(2,"0")}`;
}

function setFeedback(text, ok){
  fEl.textContent = text;
  fEl.className = "feedback " + (ok ? "good" : "bad");
}

function clearFeedback(){
  fEl.textContent = "";
  fEl.className = "feedback";
}

/* =========================
   5) Vraag generatie
========================= */
function makeQuestion(){
  const lvl = getLevel();

  // Niveau 10: stipsommen: a √ó ... = product
  if(lvl === 9){
    const a = pick([2,3,4,5,6,7,8,9,10]);
    const b = r(0,10);
    correctAnswer = b;
    qEl.textContent = `${a} √ó ‚Ä¶ = ${a*b}`;
    return;
  }

  // Niveau 11: grote keersommen
  if(lvl === 10){
    const type = pick(["tiental","honderdtal","tientalxtiental"]);

    if(type === "tiental"){
      const a = pick([10,20,30,40,50,60,70,80,90]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }

    if(type === "honderdtal"){
      const a = pick([100,200,300,400,500,600,700,800,900]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }

    // 80 √ó 90 etc.
    const a = pick([10,20,30,40,50,60,70,80,90]);
    const b = pick([10,20,30,40,50,60,70,80,90]);
    correctAnswer = a*b;
    qEl.textContent = `${a} √ó ${b}`;
    return;
  }

  // Normale tafels per niveau
  let tables = [2];

  if(lvl===0) tables=[2];
  if(lvl===1) tables=[2,10];
  if(lvl===2) tables=[2,5,10];
  if(lvl===3) tables=[3,4];
  if(lvl===4) tables=[2,3,4,5,10];
  if(lvl===5) tables=[6,7];
  if(lvl===6) tables=[2,3,4,5,6,7,10];
  if(lvl===7) tables=[8,9];
  if(lvl===8) tables=[2,3,4,5,6,7,8,9,10];

  const tafel = pick(tables);
  const getal = r(0,10);

  // jouw wens: 8 √ó 2 (dus eerst het getal)
  correctAnswer = getal * tafel;
  qEl.textContent = `${getal} √ó ${tafel}`;
}

/* =========================
   6) Run start/stop
========================= */
function resetRun(){
  running=false;
  if(timer){ clearInterval(timer); timer=null; }
  time=120;
  good=0;
  tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  qEl.textContent="Klik op start";
  aEl.value="";
  aEl.disabled=true;
  startBtn.disabled=false;
  clearFeedback();
}

function startRun(){
  running=true;
  startBtn.disabled=true;

  time=120;
  good=0;
  tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  clearFeedback();

  aEl.disabled=false;
  aEl.value="";
  aEl.focus();

  makeQuestion();

  if(timer) clearInterval(timer);
  timer=setInterval(()=>{
    time--;
    fmtTime();

    if(time<=0){
      clearInterval(timer);
      timer=null;
      running=false;
      aEl.disabled=true;
      startBtn.disabled=false;

      // level-up check
      const lvl = getLevel();
      if(good >= PROMOTE_AT && lvl < LEVELS.length-1){
        setLevel(lvl+1);
        renderLevel();
        alert("üéâ Niveau omhoog!");
      }
    }
  }, 1000);
}

/* =========================
   7) Antwoord afhandeling
========================= */
function submitAnswer(){
  if(!running) return;

  // alleen cijfers
  const raw = aEl.value.trim().replace(/[^0-9]/g,"");
  if(raw==="") return;

  tries++;
  triesEl.textContent = String(tries);

  const val = Number(raw);
  if(val === correctAnswer){
    good++;
    goodEl.textContent = String(good);
    setFeedback("Goed!", true);
  }else{
    setFeedback(`Fout (antwoord: ${correctAnswer})`, false);
  }

  aEl.value="";
  makeQuestion();
  aEl.focus();
}

// Enter = check
aEl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter") submitAnswer();
});

/* =========================
   8) Code maken / laden
   (zelfde stijl als bij delen)
========================= */
const codeEl = document.getElementById("code");
const msgEl = document.getElementById("msg");

function checksum(str){
  let h=0;
  for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))>>>0;
  return h.toString(36);
}
function b64encode(str){ return btoa(unescape(encodeURIComponent(str))); }
function b64decode(str){ return decodeURIComponent(escape(atob(str))); }

document.getElementById("makeBtn").addEventListener("click", ()=>{
  const d = getData();
  const payload = { v:1, id:d.id, levels:d.levels };
  const json = JSON.stringify(payload);
  const packed = b64encode(json) + "." + checksum(json);

  codeEl.value = packed;
  codeEl.select();
  try{ document.execCommand("copy"); }catch(e){}
  msgEl.textContent = "‚úÖ Code gemaakt (vaak al gekopieerd). Plak in MOO.";
});

document.getElementById("loadBtn").addEventListener("click", ()=>{
  const raw = (codeEl.value||"").trim();
  if(!raw){ msgEl.textContent="Plak eerst een code."; return; }

  const parts = raw.split(".");
  if(parts.length!==2){ msgEl.textContent="Code klopt niet (formaat)."; return; }

  try{
    const json = b64decode(parts[0]);
    if(checksum(json)!==parts[1]){ msgEl.textContent="Code klopt niet (controle)."; return; }

    const payload = JSON.parse(json);
    if(!payload || payload.v!==1 || payload.id!==studentId || !payload.levels){
      msgEl.textContent="Deze code is niet voor deze leerling.";
      return;
    }

    // levels samenvoegen
    const d = getData();
    d.levels = d.levels || { plus:0, min:0, keer:0, deel:0 };
    d.levels = { ...d.levels, ...payload.levels };
    saveData(d);

    renderLevel();
    msgEl.textContent="‚úÖ Code geladen!";
  }catch(e){
    msgEl.textContent="Kon code niet lezen.";
  }
});

/* =========================
   9) Startknop + init
========================= */
startBtn.addEventListener("click", startRun);
renderLevel();
fmtTime();
</script>
</body>
</html>
