<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keersommen</title>
  <style>
    body{
      font-family:system-ui,sans-serif;
      background:#f4f6ff;
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center
    }
    .box{
      background:#fff;
      padding:2rem 2.4rem;
      border-radius:1.5rem;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
      max-width:820px;
      width:95%;
      text-align:center
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom:1rem;
      flex-wrap:wrap;
    }
    a{
      text-decoration:none;
      font-weight:800;
      color:#4f46e5
    }
    .pill{
      background:#eef2ff;
      padding:.35rem .7rem;
      border-radius:999px;
      font-weight:900
    }
    h1{
      margin:.2rem 0 1rem 0;
      font-size:2.2rem;
    }
    .levelbar{
      margin:.2rem auto 1.2rem auto;
      background:#eef2ff;
      padding:.6rem .9rem;
      border-radius:999px;
      font-weight:900;
      max-width:560px;
    }
    .stats{
      font-size:1.1rem;
      margin:.8rem 0 1.4rem 0;
    }
    .q{
      font-size:4rem;
      margin:1.2rem 0 1.2rem 0;
      min-height:4.2rem;
      letter-spacing:1px;
    }
    #answer{
      font-size:1.8rem;
      padding:.6rem 1rem;
      width:260px;
      text-align:center;
      border-radius:1rem;
      border:2px solid #cfcfe6;
      outline:none;
    }
    #answer:focus{
      border-color:#4f46e5;
      box-shadow:0 0 0 3px rgba(79,70,229,.18);
    }
    .feedback{
      height:1.6rem;
      font-weight:900;
      margin-top:.6rem;
    }
    .good{color:#16a34a}
    .bad{color:#dc2626}

    button{
      margin-top:1.1rem;
      padding:.85rem 1.35rem;
      border:none;
      border-radius:999px;
      background:#4f46e5;
      color:white;
      font-weight:900;
      cursor:pointer;
      font-size:1rem;
      min-width:140px;
    }
    button.secondary{
      background:#0f172a;
    }
    button:disabled{
      background:#b9b9c7;
      cursor:default;
    }

    .note{
      margin-top:1.2rem;
      font-size:.9rem;
      color:#666;
    }
  </style>
</head>

<body>
  <div class="box">
    <div class="top">
      <a href="menu.html">‚Üê Menu</a>
      <div class="pill" id="who">Leerling: -</div>
    </div>

    <h1>Keersommen</h1>
    <div class="levelbar" id="level">Niveau: laden‚Ä¶</div>

    <div class="stats">
      ‚è± <span id="time">2:00</span> |
      ‚úÖ <span id="good">0</span> |
      üìä <span id="tries">0</span>
    </div>

    <div class="q" id="question">Klik op start</div>
    <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="antwoord" disabled>
    <div class="feedback" id="feedback"></div>

    <button id="startBtn" disabled>Start</button>

    <div class="note" id="statusNote">Niveau wordt centraal geladen‚Ä¶</div>
  </div>

<script>
/* =========================
   0) GOOGLE SHEETS (JSONP)
========================= */
https://script.google.com/macros/s/AKfycbz1CoVtmg3brs0r_G3mRvznGWG0utgi4AYrW-eDFkoCx2pwhZeCVetqDj4pf-Gtih6WMw/exec
function sheetsJSONP(params){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const s = document.createElement("script");
    s.src = SHEETS_API + "?" + qs;

    window[cb] = (data) => {
      delete window[cb];
      s.remove();
      resolve(data);
    };

    s.onerror = () => {
      delete window[cb];
      s.remove();
      reject(new Error("Sheets JSONP load error"));
    };

    document.head.appendChild(s);
  });
}

async function loadLevelsFromSheets(studentId){
  const res = await sheetsJSONP({ action:"get", code: studentId });
  if(res && res.ok && res.found){
    return {
      plus: Number(res.plus ?? 0),
      min:  Number(res.min  ?? 0),
      keer: Number(res.keer ?? 0),
      deel: Number(res.deel ?? 0),
      naam: res.naam ?? studentId
    };
  }
  return { plus:0, min:0, keer:0, deel:0, naam: studentId };
}

async function saveLevelsToSheets(studentId, levels){
  // levels = { plus, min, keer, deel, naam? }
  const res = await sheetsJSONP({
    action:"set",
    code: studentId,
    naam: (levels.naam ?? studentId),
    plus: levels.plus ?? 0,
    min:  levels.min  ?? 0,
    keer: levels.keer ?? 0,
    deel: levels.deel ?? 0
  });
  return res;
}

/* =========================
   1) Leerling + lokale fallback
========================= */
const CURRENT = "rekenen_current_student_v1";
const DATA_PREFIX = "rekenen_data_v1_";

const studentId = localStorage.getItem(CURRENT);
if(!studentId){
  location.href = "index.html";
}

document.getElementById("who").textContent = `Leerling: ${studentId}`;
const statusNote = document.getElementById("statusNote");

function dataKey(){ return DATA_PREFIX + studentId; }

function getLocalData(){
  return JSON.parse(localStorage.getItem(dataKey())) || {
    v: 1,
    id: studentId,
    levels: { plus:0, min:0, keer:0, deel:0 }
  };
}

function saveLocalData(d){
  localStorage.setItem(dataKey(), JSON.stringify(d));
}

/* =========================
   2) Niveau‚Äôs (Keer)
========================= */
const LEVELS = [
  "Tafel van 2",
  "Tafel van 2 en 10",
  "Tafel van 2, 5 en 10",
  "Tafel van 3 en 4",
  "Tafel van 2,3,4,5 en 10",
  "Tafel van 6 en 7",
  "Tafel van 2,3,4,5,6,7 en 10",
  "Tafel van 8 en 9",
  "Alle tafels",
  "Stipsommen met tafels (8 √ó ‚Ä¶ = 56)",
  "Grote keersommen (80√ó9, 800√ó9, 80√ó90)"
];

const PROMOTE_AT = 24;

let levels = { plus:0, min:0, keer:0, deel:0, naam: studentId };

function clampLevel(lvl){
  return Math.max(0, Math.min(Number(lvl)||0, LEVELS.length-1));
}

function getKeerLevel(){
  return clampLevel(levels.keer);
}

function setKeerLevel(lvl){
  levels.keer = clampLevel(lvl);

  // lokale backup opslaan
  const d = getLocalData();
  d.levels = d.levels || { plus:0, min:0, keer:0, deel:0 };
  d.levels.keer = levels.keer;
  saveLocalData(d);
}

function renderLevel(){
  document.getElementById("level").textContent = "Niveau: " + LEVELS[getKeerLevel()];
}

/* =========================
   3) Random helpers
========================= */
function r(min, max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function pick(arr){
  return arr[r(0, arr.length-1)];
}

/* =========================
   4) Spel state + UI refs
========================= */
const qEl = document.getElementById("question");
const aEl = document.getElementById("answer");
const fEl = document.getElementById("feedback");
const tEl = document.getElementById("time");
const goodEl = document.getElementById("good");
const triesEl = document.getElementById("tries");
const startBtn = document.getElementById("startBtn");

let running=false;
let timer=null;
let time=120;
let good=0;
let tries=0;
let correctAnswer=0;

function fmtTime(){
  tEl.textContent = `${Math.floor(time/60)}:${String(time%60).padStart(2,"0")}`;
}

function setFeedback(text, ok){
  fEl.textContent = text;
  fEl.className = "feedback " + (ok ? "good" : "bad");
}

function clearFeedback(){
  fEl.textContent = "";
  fEl.className = "feedback";
}

/* =========================
   5) Vraag generatie
========================= */
function makeQuestion(){
  const lvl = getKeerLevel();

  // Niveau 10: stipsommen: a √ó ... = product
  if(lvl === 9){
    const a = pick([2,3,4,5,6,7,8,9,10]);
    const b = r(0,10);
    correctAnswer = b;
    qEl.textContent = `${a} √ó ‚Ä¶ = ${a*b}`;
    return;
  }

  // Niveau 11: grote keersommen
  if(lvl === 10){
    const type = pick(["tiental","honderdtal","tientalxtiental"]);

    if(type === "tiental"){
      const a = pick([10,20,30,40,50,60,70,80,90]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }

    if(type === "honderdtal"){
      const a = pick([100,200,300,400,500,600,700,800,900]);
      const b = r(2,9);
      correctAnswer = a*b;
      qEl.textContent = `${a} √ó ${b}`;
      return;
    }

    // 80 √ó 90 etc.
    const a = pick([10,20,30,40,50,60,70,80,90]);
    const b = pick([10,20,30,40,50,60,70,80,90]);
    correctAnswer = a*b;
    qEl.textContent = `${a} √ó ${b}`;
    return;
  }

  // Normale tafels per niveau
  let tables = [2];

  if(lvl===0) tables=[2];
  if(lvl===1) tables=[2,10];
  if(lvl===2) tables=[2,5,10];
  if(lvl===3) tables=[3,4];
  if(lvl===4) tables=[2,3,4,5,10];
  if(lvl===5) tables=[6,7];
  if(lvl===6) tables=[2,3,4,5,6,7,10];
  if(lvl===7) tables=[8,9];
  if(lvl===8) tables=[2,3,4,5,6,7,8,9,10];

  const tafel = pick(tables);
  const getal = r(0,10);

  // jouw wens: 8 √ó 2 (dus eerst het getal)
  correctAnswer = getal * tafel;
  qEl.textContent = `${getal} √ó ${tafel}`;
}

/* =========================
   6) Run start/stop
========================= */
function resetRun(){
  running=false;
  if(timer){ clearInterval(timer); timer=null; }
  time=120;
  good=0;
  tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  qEl.textContent="Klik op start";
  aEl.value="";
  aEl.disabled=true;
  startBtn.disabled=false;
  clearFeedback();
}

function startRun(){
  running=true;
  startBtn.disabled=true;

  time=120;
  good=0;
  tries=0;
  fmtTime();
  goodEl.textContent="0";
  triesEl.textContent="0";
  clearFeedback();

  aEl.disabled=false;
  aEl.value="";
  aEl.focus();

  makeQuestion();

  if(timer) clearInterval(timer);
  timer=setInterval(async ()=>{
    time--;
    fmtTime();

    if(time<=0){
      clearInterval(timer);
      timer=null;
      running=false;
      aEl.disabled=true;
      startBtn.disabled=false;

      // level-up check
      const lvl = getKeerLevel();
      let changed = false;

      if(good >= PROMOTE_AT && lvl < LEVELS.length-1){
        setKeerLevel(lvl+1);
        renderLevel();
        changed = true;
        alert("üéâ Niveau omhoog!");
      }

      // altijd even opslaan naar Sheets (zeker als level veranderd is)
      try{
        statusNote.textContent = "Opslaan‚Ä¶";
        await saveLevelsToSheets(studentId, levels);
        statusNote.textContent = changed ? "Niveau opgeslagen (centraal) ‚úÖ" : "Resultaat opgeslagen ‚úÖ";
      }catch(e){
        statusNote.textContent = "Opslaan naar Sheets lukt niet (tijdelijk).";
      }
    }
  }, 1000);
}

/* =========================
   7) Antwoord afhandeling
========================= */
function submitAnswer(){
  if(!running) return;

  const raw = aEl.value.trim().replace(/[^0-9]/g,"");
  if(raw==="") return;

  tries++;
  triesEl.textContent = String(tries);

  const val = Number(raw);
  if(val === correctAnswer){
    good++;
    goodEl.textContent = String(good);
    setFeedback("Goed!", true);
  }else{
    setFeedback(`Fout (antwoord: ${correctAnswer})`, false);
  }

  aEl.value="";
  makeQuestion();
  aEl.focus();
}

aEl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter") submitAnswer();
});

/* =========================
   8) Init: levels laden uit Sheets
========================= */
async function init(){
  fmtTime();

  // fallback: laad wat je lokaal had (voor het geval Sheets even faalt)
  const local = getLocalData();
  if(local?.levels){
    levels.plus = local.levels.plus ?? 0;
    levels.min  = local.levels.min  ?? 0;
    levels.keer = local.levels.keer ?? 0;
    levels.deel = local.levels.deel ?? 0;
  }

  try{
    statusNote.textContent = "Niveau laden‚Ä¶";
    const remote = await loadLevelsFromSheets(studentId);
    levels = { ...levels, ...remote };

    // lokale backup bijwerken
    const d = getLocalData();
    d.levels = d.levels || { plus:0, min:0, keer:0, deel:0 };
    d.levels.plus = levels.plus ?? 0;
    d.levels.min  = levels.min  ?? 0;
    d.levels.keer = levels.keer ?? 0;
    d.levels.deel = levels.deel ?? 0;
    saveLocalData(d);

    statusNote.textContent = "Niveau geladen (centraal) ‚úÖ";
  }catch(e){
    statusNote.textContent = "Kon niveau niet laden uit Sheets (lokale backup gebruikt).";
  }

  renderLevel();
  startBtn.disabled = false;
}

document.getElementById("startBtn").addEventListener("click", startRun);
init();
</script>
</body>
</html>
