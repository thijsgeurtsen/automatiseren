<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Optellen ‚Äì adaptief (stipsommen)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body{font-family:system-ui,sans-serif;background:#f4f6ff;margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center}
    .box{background:#fff;padding:2.2rem 2.4rem;border-radius:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:760px;width:95%;text-align:center}
    .top{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
    a.small{color:#4f46e5;text-decoration:none;font-weight:800}
    .pill{display:inline-block;padding:.35rem .7rem;border-radius:999px;background:#eef2ff;font-weight:900}
    h1{margin:.2rem 0 .2rem}
    .sub{color:#555;margin:0 0 .75rem}
    .row{display:flex;justify-content:space-between;gap:.8rem;flex-wrap:wrap;margin:1rem 0;font-weight:900}
    .q{font-size:3rem;margin:1rem 0;min-height:3rem}
    .q small{font-size:1.2rem;color:#666;font-weight:800}
    input[type="number"]{font-size:1.6rem;padding:.5rem .9rem;width:240px;text-align:center;border-radius:.9rem;border:2px solid #ccc;outline:none}
    input:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.15)}
    button{padding:.8rem 1.3rem;border:none;border-radius:999px;background:#4f46e5;color:#fff;font-weight:900;cursor:pointer}
    button:disabled{background:#bbb;cursor:default}
    .feedback{height:1.4rem;margin-top:.5rem;font-weight:900}
    .good{color:#16a34a}.bad{color:#dc2626}
    .result{margin-top:1rem;font-weight:900}
    .smalltxt{font-size:.85rem;color:#666}
    .status{margin-top:.35rem}
  </style>
</head>
<body>
  <div class="box">
    <div class="top">
      <a class="small" href="menu.html">‚Üê Menu</a>
      <div class="pill" id="who">‚Äî</div>
    </div>

    <h1>Optellen</h1>
    <p class="sub">Adaptief: niveau omhoog bij <b>24 of meer</b> goede antwoorden (2 minuten).</p>
    <div class="smalltxt status" id="sheetStatus">Sheets: verbinden‚Ä¶</div>

    <div class="row">
      <div>‚è± <span id="time">2:00</span></div>
      <div>‚úÖ <span id="good">0</span></div>
      <div>üìä <span id="tries">0</span></div>
    </div>

    <div class="pill" id="level">Niveau: laden‚Ä¶</div>

    <div class="q" id="q">Druk op start</div>
    <input id="ans" type="number" placeholder="antwoord" disabled>
    <div id="fb" class="feedback"></div>

    <div style="margin-top:1rem">
      <button id="start" disabled>Start 2-minutentest</button>
    </div>

    <div id="res" class="result"></div>
  </div>

<script>
/* =========================
   A) CONFIG: jouw Apps Script exec-url
========================= */
const SHEETS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzwJm59S4rcRcLyvzxslTocnBSYv7KnOinPn72X9ji43CkQhDwjyY8gfjE7YnP-zYUBTQ/exec";

/* =========================
   B) leerling uit localStorage
========================= */
const STORAGE_CURRENT = "rekenen_current_student_v1";
const studentId = (localStorage.getItem(STORAGE_CURRENT) || "").trim();
if(!studentId) location.href = "index.html";
document.getElementById("who").textContent = `Leerling: ${studentId}`;

/* =========================
   C) Local fallback (alleen als Sheets faalt)
========================= */
const STORAGE_DATA_PREFIX = "rekenen_data_v1_";
function dataKey(){ return STORAGE_DATA_PREFIX + studentId; }
function getLocalData(){
  const raw = localStorage.getItem(dataKey());
  return raw ? JSON.parse(raw) : { v:1, id:studentId, levels:{plus:0,min:0,keer:0,deel:0} };
}
function setLocalData(d){ localStorage.setItem(dataKey(), JSON.stringify(d)); }

/* =========================
   D) JSONP helper (GitHub Pages-proof)
========================= */
let __jsonpSeq = 0;
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "__cb_" + (++__jsonpSeq) + "_" + Date.now();
    const script = document.createElement("script");

    const cleanup = () => { delete window[cb]; script.remove(); };
    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    document.body.appendChild(script);
  });
}

async function sheetsGet(leerling){
  const url = `${SHEETS_EXEC_URL}?action=get&leerling=${encodeURIComponent(leerling)}`;
  return await jsonp(url);
}

async function sheetsSet(leerling, levels){
  const url =
    `${SHEETS_EXEC_URL}?action=set&leerling=${encodeURIComponent(leerling)}`
    + `&plus=${encodeURIComponent(levels.plus)}`
    + `&min=${encodeURIComponent(levels.min)}`
    + `&keer=${encodeURIComponent(levels.keer)}`
    + `&deel=${encodeURIComponent(levels.deel)}`;
  return await jsonp(url);
}

/* =========================
   E) instellingen / niveaus
========================= */
const THRESHOLD = 24;
const SECONDS = 120;
const DOTS = "...";

const LEVELS = [
  { name: "Niveau 1: optellen t/m 10" },
  { name: "Niveau 2: stipsommen t/m 10" },
  { name: "Niveau 3: tussen 10 en 20 (14 + 3)" },
  { name: "Niveau 4: stipsommen (vriendjes van 10)" },
  { name: "Niveau 5: t/m 20 met overschrijding (8 + 5)" },
  { name: "Niveau 6: stipsommen t/m 20" },
  { name: "Niveau 7: t/m 100 ‚Äì tientallen (40 + 20)" },
  { name: "Niveau 8: tientallen bij tiental+eenheid (43 + 20)" },
  { name: "Niveau 9: eenheden zonder overschrijding (43 + 3)" },
  { name: "Niveau 10: eenheden met overschrijding (58 + 6)" },
  { name: "Niveau 11: tient+eenh zonder overschrijding (42 + 14)" },
  { name: "Niveau 12: tient+eenh met overschrijding (48 + 24)" },
];

/* =========================
   F) UI
========================= */
const timeEl = document.getElementById("time");
const goodEl = document.getElementById("good");
const triesEl = document.getElementById("tries");
const levelEl = document.getElementById("level");
const qEl = document.getElementById("q");
const ansEl = document.getElementById("ans");
const fbEl = document.getElementById("fb");
const resEl = document.getElementById("res");
const startBtn = document.getElementById("start");
const sheetStatusEl = document.getElementById("sheetStatus");

/* =========================
   G) state
========================= */
let timer=null, t=SECONDS, good=0, tries=0, correct=0, active=false;

let sheetsOk = false;
let levels = { plus:0, min:0, keer:0, deel:0 };

function clampLevel(n){
  n = Number(n) || 0;
  return Math.min(Math.max(0, n), LEVELS.length-1);
}
function getLevelIndex(){
  return clampLevel(levels.plus);
}
function renderLevel(){
  const i = getLevelIndex();
  levelEl.textContent = `Niveau: ${LEVELS[i].name}`;
}

function fmt(s){ return Math.floor(s/60)+":"+String(s%60).padStart(2,"0"); }
function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function tryLoop(makeFn, okFn){
  for(let k=0;k<300;k++){
    const v = makeFn();
    if(okFn(v)) return v;
  }
  return makeFn();
}

/* =========================
   H) vragen
========================= */
function makeQuestionForLevel(level){
  let a=0,b=0,target=0,miss=0;

  switch(level){

    // 1) optellen t/m 10 (som <= 10)
    case 0: {
      const p = tryLoop(()=>({a:r(0,10), b:r(0,10)}), (x)=> x.a + x.b <= 10);
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 2) stipsommen t/m 10: a + ... = target (target<=10)
    case 1: {
      const p = tryLoop(()=>({a:r(0,9), target:r(1,10)}), (x)=> x.target > x.a);
      a=p.a; target=p.target;
      miss = target - a;
      return { html: `${a} + ${DOTS} = ${target}<br><small>Wat moet erbij?</small>`, answer: miss };
    }

    // 3) tussen 10 en 20 (a 10..19, b 1..10, som 11..20)
    case 2: {
      const p = tryLoop(
        ()=>({a:r(10,19), b:r(1,10)}),
        (x)=> x.a+x.b >= 11 && x.a+x.b <= 20
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 4) vriendjes van 10: a + ... = 10
    case 3: {
      a = r(1,9);
      miss = 10 - a;
      return { html: `${a} + ${DOTS} = 10<br><small>Vriendjes van 10</small>`, answer: miss };
    }

    // 5) t/m 20 met overschrijding (8+5 etc. som 11..20)
    case 4: {
      const p = tryLoop(
        ()=>({a:r(1,9), b:r(1,9)}),
        (x)=> x.a+x.b >= 11 && x.a+x.b <= 20
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 6) stipsommen t/m 20: a + ... = target (target<=20)
    case 5: {
      const p = tryLoop(()=>({a:r(0,19), target:r(1,20)}), (x)=> x.target > x.a);
      a=p.a; target=p.target;
      miss = target - a;
      return { html: `${a} + ${DOTS} = ${target}<br><small>Wat moet erbij?</small>`, answer: miss };
    }

    // 7) tientallen optellen (som <= 100)
    case 6: {
      const p = tryLoop(()=>({a:r(1,9)*10, b:r(1,9)*10}), (x)=> x.a+x.b <= 100);
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 8) tientallen bij tiental+eenheid (a%10 != 0, som <= 100)
    case 7: {
      const p = tryLoop(()=>({a:r(10,99), b:r(1,9)*10}), (x)=> (x.a%10!==0) && (x.a+x.b<=100));
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 9) eenheden zonder overschrijding (eenheden + b <= 9)
    case 8: {
      const p = tryLoop(
        ()=>({a:r(10,99), b:r(1,9)}),
        (x)=> (x.a%10!==0) && ((x.a%10)+x.b<=9) && (x.a+x.b<=100)
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 10) eenheden met overschrijding (eenheden + b >= 10)
    case 9: {
      const p = tryLoop(
        ()=>({a:r(10,99), b:r(1,9)}),
        (x)=> (x.a%10!==0) && ((x.a%10)+x.b>=10) && (x.a+x.b<=100)
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 11) tient+eenh zonder overschrijding (eenheden som <= 9)
    case 10: {
      const p = tryLoop(
        ()=>({a:r(10,99), b:r(10,99)}),
        (x)=> (x.a%10!==0) && (x.b%10!==0) && ((x.a%10)+(x.b%10)<=9) && (x.a+x.b<=100)
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }

    // 12) tient+eenh met overschrijding (eenheden som >= 10)
    case 11: {
      const p = tryLoop(
        ()=>({a:r(10,99), b:r(10,99)}),
        (x)=> (x.a%10!==0) && (x.b%10!==0) && ((x.a%10)+(x.b%10)>=10) && (x.a+x.b<=100)
      );
      a=p.a; b=p.b;
      return { html: `${a} + ${b} = ?`, answer: a+b };
    }
  }
}

function newQ(){
  const i = getLevelIndex();
  const q = makeQuestionForLevel(i);
  correct = q.answer;
  qEl.innerHTML = q.html;
  ansEl.value = "";
  ansEl.focus();
}

/* =========================
   I) opslaan levels
========================= */
async function saveLevels(){
  if(sheetsOk){
    await sheetsSet(studentId, levels);
    return;
  }
  const d = getLocalData();
  d.levels = d.levels || {plus:0,min:0,keer:0,deel:0};
  d.levels = { ...d.levels, ...levels };
  setLocalData(d);
}

/* =========================
   J) start/stop
========================= */
function start(){
  if(active) return;
  active=true; good=0; tries=0; t=SECONDS;

  goodEl.textContent="0";
  triesEl.textContent="0";
  fbEl.textContent="";
  fbEl.className="feedback";
  resEl.textContent="";

  ansEl.disabled=false;
  startBtn.disabled=true;

  renderLevel();
  newQ();
  timeEl.textContent = fmt(t);

  clearInterval(timer);
  timer=setInterval(()=>{
    t--;
    timeEl.textContent=fmt(t);
    if(t<=0) end();
  },1000);
}

async function end(){
  clearInterval(timer);
  active=false;
  ansEl.disabled=true;
  startBtn.disabled=false;

  const pct = Math.round((good/tries)*100) || 0;
  let msg = `Je had ${good} goed van ${tries} pogingen. (${pct}%)`;

  const i = getLevelIndex();
  if(good >= THRESHOLD && i < LEVELS.length-1){
    levels.plus = i + 1;
    renderLevel();

    sheetStatusEl.textContent = sheetsOk ? "Sheets: niveau opslaan‚Ä¶" : "Lokaal: niveau opslaan‚Ä¶";
    try{
      await saveLevels();
      sheetStatusEl.textContent = sheetsOk ? "Sheets: opgeslagen ‚úÖ" : "Lokaal: opgeslagen ‚úÖ";
    }catch(e){
      sheetStatusEl.textContent = sheetsOk ? "Sheets: opslaan mislukt ‚ö†Ô∏è" : "Lokaal: opslaan mislukt ‚ö†Ô∏è";
    }

    msg += " üéâ Niveau omhoog!";
  } else {
    msg += ` (Huidig niveau: ${LEVELS[i].name})`;
  }

  resEl.textContent = msg;
  renderLevel();
}

ansEl.addEventListener("keydown",(e)=>{
  if(e.key!=="Enter" || !active) return;
  if(ansEl.value==="") return;

  tries++;
  triesEl.textContent=String(tries);

  if(Number(ansEl.value)===correct){
    good++;
    goodEl.textContent=String(good);
    fbEl.textContent="Goed!";
    fbEl.className="feedback good";
  } else {
    fbEl.textContent=`Helaas, het was ${correct}.`;
    fbEl.className="feedback bad";
  }
  newQ();
});

startBtn.addEventListener("click", start);

/* =========================
   K) INIT: levels laden (Sheets -> anders lokaal)
========================= */
(async function init(){
  timeEl.textContent = fmt(SECONDS);
  startBtn.disabled = true;
  sheetStatusEl.textContent = "Sheets: laden‚Ä¶";

  try{
    const res = await sheetsGet(studentId);
    if(res && res.ok === true && res.levels){
      levels = {
        plus: Number(res.levels.plus) || 0,
        min:  Number(res.levels.min)  || 0,
        keer: Number(res.levels.keer) || 0,
        deel: Number(res.levels.deel) || 0
      };
      sheetsOk = true;
      sheetStatusEl.textContent = "Sheets: verbonden ‚úÖ";
    } else {
      throw new Error("Unexpected response");
    }
  }catch(e){
    const d = getLocalData();
    levels = {
      plus: Number(d.levels?.plus) || 0,
      min:  Number(d.levels?.min)  || 0,
      keer: Number(d.levels?.keer) || 0,
      deel: Number(d.levels?.deel) || 0
    };
    sheetsOk = false;
    sheetStatusEl.textContent = "Kon niveau niet laden uit Sheets (lokale backup gebruikt).";
  }

  renderLevel();
  startBtn.disabled = false;
})();
</script>
</body>
</html>
